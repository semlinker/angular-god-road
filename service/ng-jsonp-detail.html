<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、什么是 JSONP | Angular 修仙之路</title>
    <meta name="description" content="修炼 Angular、RxJS、TypeScript 秘籍">
    
    
    <link rel="preload" href="/angular-god-road/assets/css/styles.4eaf616f.css" as="style"><link rel="preload" href="/angular-god-road/assets/js/app.4eaf616f.js" as="script"><link rel="preload" href="/angular-god-road/assets/js/34.c0d5a741.js" as="script"><link rel="prefetch" href="/angular-god-road/assets/css/1.styles.24fddc56.css"><link rel="prefetch" href="/angular-god-road/assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="/angular-god-road/assets/js/1.24fddc56.js"><link rel="prefetch" href="/angular-god-road/assets/js/10.edd26f16.js"><link rel="prefetch" href="/angular-god-road/assets/js/11.33f54712.js"><link rel="prefetch" href="/angular-god-road/assets/js/12.fcc87fd4.js"><link rel="prefetch" href="/angular-god-road/assets/js/13.fa6e9f88.js"><link rel="prefetch" href="/angular-god-road/assets/js/14.050d9df1.js"><link rel="prefetch" href="/angular-god-road/assets/js/15.9f880834.js"><link rel="prefetch" href="/angular-god-road/assets/js/16.b96760bb.js"><link rel="prefetch" href="/angular-god-road/assets/js/17.13fefc8b.js"><link rel="prefetch" href="/angular-god-road/assets/js/18.c850d375.js"><link rel="prefetch" href="/angular-god-road/assets/js/19.7239064a.js"><link rel="prefetch" href="/angular-god-road/assets/js/2.a2bd3099.js"><link rel="prefetch" href="/angular-god-road/assets/js/20.4125efb9.js"><link rel="prefetch" href="/angular-god-road/assets/js/21.2a9e4d33.js"><link rel="prefetch" href="/angular-god-road/assets/js/22.f2cf7fbc.js"><link rel="prefetch" href="/angular-god-road/assets/js/23.7ff8e04e.js"><link rel="prefetch" href="/angular-god-road/assets/js/24.9f44b1b7.js"><link rel="prefetch" href="/angular-god-road/assets/js/25.0ec2854a.js"><link rel="prefetch" href="/angular-god-road/assets/js/26.7c66210d.js"><link rel="prefetch" href="/angular-god-road/assets/js/27.d9097f9d.js"><link rel="prefetch" href="/angular-god-road/assets/js/28.7d96a001.js"><link rel="prefetch" href="/angular-god-road/assets/js/29.4fc02651.js"><link rel="prefetch" href="/angular-god-road/assets/js/3.3d49ed81.js"><link rel="prefetch" href="/angular-god-road/assets/js/30.99a6671a.js"><link rel="prefetch" href="/angular-god-road/assets/js/31.2591ba92.js"><link rel="prefetch" href="/angular-god-road/assets/js/32.78ddd0be.js"><link rel="prefetch" href="/angular-god-road/assets/js/33.e9af0299.js"><link rel="prefetch" href="/angular-god-road/assets/js/35.284fb844.js"><link rel="prefetch" href="/angular-god-road/assets/js/36.1cb64f86.js"><link rel="prefetch" href="/angular-god-road/assets/js/37.b69ebefc.js"><link rel="prefetch" href="/angular-god-road/assets/js/38.048dd2ef.js"><link rel="prefetch" href="/angular-god-road/assets/js/39.9e4eec87.js"><link rel="prefetch" href="/angular-god-road/assets/js/4.ff267ab9.js"><link rel="prefetch" href="/angular-god-road/assets/js/40.9610211f.js"><link rel="prefetch" href="/angular-god-road/assets/js/41.ddd45347.js"><link rel="prefetch" href="/angular-god-road/assets/js/42.d2ebe819.js"><link rel="prefetch" href="/angular-god-road/assets/js/43.e1f5311e.js"><link rel="prefetch" href="/angular-god-road/assets/js/44.b5c3267a.js"><link rel="prefetch" href="/angular-god-road/assets/js/45.b34d49e9.js"><link rel="prefetch" href="/angular-god-road/assets/js/46.3602c3b6.js"><link rel="prefetch" href="/angular-god-road/assets/js/5.488dbe6d.js"><link rel="prefetch" href="/angular-god-road/assets/js/6.1c8c7528.js"><link rel="prefetch" href="/angular-god-road/assets/js/7.fc1d55b7.js"><link rel="prefetch" href="/angular-god-road/assets/js/8.0ebf2d9c.js"><link rel="prefetch" href="/angular-god-road/assets/js/9.dacb7e8b.js">
    <link rel="stylesheet" href="/angular-god-road/assets/css/1.styles.24fddc56.css"><link rel="stylesheet" href="/angular-god-road/assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="/angular-god-road/assets/css/styles.4eaf616f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/angular-god-road/" class="home-link router-link-active"><!----> <span class="site-name">Angular 修仙之路</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/angular-god-road/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://semlinker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端修仙之路
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/semlinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/angular-god-road/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://semlinker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端修仙之路
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/semlinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>入门篇</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/angular-god-road/quickstart/ng-quickstart.html" class="sidebar-link">Angular 6 快速入门</a></li><li><a href="/angular-god-road/quickstart/ng-base-tutorial.html" class="sidebar-link">Angular 6 基础教程</a></li><li><a href="/angular-god-road/quickstart/ng-pipe-quickstart.html" class="sidebar-link">Angular 6 管道快速入门</a></li><li><a href="/angular-god-road/quickstart/ng-form-quickstart.html" class="sidebar-link">Angular 6 表单快速入门</a></li><li><a href="/angular-god-road/quickstart/ng-directive-quickstart.html" class="sidebar-link">Angular 6 快速入门</a></li><li><a href="/angular-god-road/quickstart/ng-http-client-quickstart.html" class="sidebar-link">Angular 6 HttpClient 快速入门</a></li><li><a href="/angular-god-road/quickstart/ng-library-quickstart.html" class="sidebar-link">Angular Library 快速入门</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工具篇</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>元素篇</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>其它</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>RxJS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>RxJS</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h3 id="一、什么是-jsonp"><a href="#一、什么是-jsonp" aria-hidden="true" class="header-anchor">#</a> 一、什么是 JSONP</h3> <p><strong>JSONP</strong>（<strong>JSON with Padding</strong>）是数据格式<a href="https://zh.wikipedia.org/wiki/JSON" target="_blank" rel="noopener noreferrer">JSON<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的一种 “使用模式”，可以让网页从别的网域要数据。另一个解决这个问题的新方法是<a href="https://zh.wikipedia.org/wiki/%E8%B7%A8%E4%BE%86%E6%BA%90%E8%B3%87%E6%BA%90%E5%85%B1%E4%BA%AB" target="_blank" rel="noopener noreferrer">跨来源资源共享<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>由于<a href="https://zh.wikipedia.org/w/index.php?title=%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5&action=edit&redlink=1" target="_blank" rel="noopener noreferrer">同源策略<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，一般来说位于 server1.example.com 的网页无法与 server2.example.com 的服务器沟通，而<a href="https://zh.wikipedia.org/wiki/HTML" target="_blank" rel="noopener noreferrer">HTML<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的 <code>script</code> 元素是一个例外。利用 <code>script</code> 元素的这个开放策略，网页可以得到从其他来源动态产生的 JSON 数据，而这种使用模式就是所谓的 JSONP。用 JSONP 抓到的数据并不是 JSON，而是任意的 JavaScript，用 JavaScript 解释器运行而不是用 JSON 解析器解析。 —— 维基百科</p> <h3 id="二、jsonp-跨域原理"><a href="#二、jsonp-跨域原理" aria-hidden="true" class="header-anchor">#</a> 二、JSONP 跨域原理</h3> <p>AJAX 无法跨域是受到 “同源策略” 的限制，但是带有 src 属性的标签（例如 <code>&lt;script&gt;、&lt;img&gt;、&lt;iframe&gt;</code>）是不受该策略限制的，因此我们可以通过向页面中动态添加 <code>&lt;script&gt;</code> 标签来完成对跨域资源的访问，这也是 JSONP 方案最核心的原理。</p> <p>通常我们使用 <code>&lt;script&gt;</code> 都是引用的静态资源，其实它也可以用来引用动态资源（php、jsp、aspx 等），后台服务被访问后会返回一个 <code>callback(data)</code>  形式的字符串，由于是字符串，因此在后台的时候不会起到任何作用，但返回浏览器端，放入 <code>&lt;script&gt;</code> 标签之内，就是一个合法的函数调用，实参就是我们所需要的数据。</p> <p>JSONP 最大的优点就是兼容性非常好，其原理决定了即便在非常古老的浏览器上也能够很好的被实现。但它也有缺点，即只支持 Get 请求，因为是通过 <code>&lt;script&gt;</code> 方式引用资源，相关的参数都显式的包含在 URL 中。</p> <h3 id="三、angular-jsonp-示例"><a href="#三、angular-jsonp-示例" aria-hidden="true" class="header-anchor">#</a> 三、Angular JSONP 示例</h3> <p>在 Angular 项目中，要使用 JSONP 实现跨域资源访问，我们需要导入 <code>HttpClientModule</code> 和 <code>HttpClientJsonpModule</code> 模块：</p> <p>app.module.ts</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/platform-browser&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpClientModule<span class="token punctuation">,</span> HttpClientJsonpModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> AppComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./app.component&quot;</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>BrowserModule<span class="token punctuation">,</span> HttpClientModule<span class="token punctuation">,</span> HttpClientJsonpModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>在导入 <code>HttpClientModule</code> 和 <code>HttpClientJsonpModule</code> 模块之后，我们就可以利用 HttpClient 对象发送请求：</p> <p>app.component.ts</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">&quot;app-root&quot;</span><span class="token punctuation">,</span>
  template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
    &lt;button (click)=&quot;search('Photo')&quot;&gt;Search photo in itunes&lt;/button&gt;
 `</span></span><span class="token punctuation">,</span>
  styles<span class="token punctuation">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  baseUrl<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;https://itunes.apple.com/search&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> http<span class="token punctuation">:</span> HttpClient<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">search</span><span class="token punctuation">(</span>term<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> searchUrl <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?term=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>term<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;media=music&amp;limit=20`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span>jsonp<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>searchUrl<span class="token punctuation">,</span> <span class="token string">&quot;callback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token builtin">console</span><span class="token punctuation">.</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来在启动应用后，我们打开开发者工具，切换到 Network Tab 栏，然后点击页面上的</p> <p><code>Search photo in itunes</code> 按钮，这时你会看到以下的请求信息：</p> <div class="language- extra-class"><pre class="language-text"><code>https://itunes.apple.com/search?term=Photo&amp;media=music&amp;limit=20&amp;callback=ng_jsonp_callback_0
</code></pre></div><p>这里我们发现调用 <code>this.http.jsonp()</code> 方法后，Angular 自动在请求的 URL 地址后面添加 <code>callback=ng_jsonp_callback_0</code> 的查询参数。接着在经过一小段时间，控制台输出了相关的数据。</p> <h3 id="四、angular-jsonp-原理简析"><a href="#四、angular-jsonp-原理简析" aria-hidden="true" class="header-anchor">#</a> 四、Angular JSONP 原理简析</h3> <p>在了解 JSONP 的工作原理之后，再看 Angular 的源码就清晰简单很多。下面我们将以 <code>this.http.jsonp()</code> 方法的调用流程为主线，简单分析一下 Angular JSONP 的实现。</p> <ol><li>this.http.jsonp(searchUrl, &quot;callback&quot;)</li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code>jsonp<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> callbackParam<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'JSONP'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      params<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">HttpParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>callbackParam<span class="token punctuation">,</span> <span class="token string">'JSONP_CALLBACK'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      observe<span class="token punctuation">:</span> <span class="token string">'body'</span><span class="token punctuation">,</span>
      responseType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>this.request('JSONP', url, {...})</li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">request</span><span class="token punctuation">(</span>first<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token operator">|</span>HttpRequest<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> url<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    body<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    headers<span class="token operator">?</span><span class="token punctuation">:</span> HttpHeaders<span class="token operator">|</span><span class="token punctuation">{</span><span class="token punctuation">[</span>header<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    observe<span class="token operator">?</span><span class="token punctuation">:</span> HttpObserve<span class="token punctuation">,</span>
    params<span class="token operator">?</span><span class="token punctuation">:</span> HttpParams<span class="token operator">|</span><span class="token punctuation">{</span><span class="token punctuation">[</span>param<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    reportProgress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    responseType<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">'arraybuffer'</span><span class="token operator">|</span><span class="token string">'blob'</span><span class="token operator">|</span><span class="token string">'json'</span><span class="token operator">|</span><span class="token string">'text'</span><span class="token punctuation">,</span>
    withCredentials<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过查看 <a href="https://github.com/angular/angular/blob/master/packages/common/http/src/client.ts#L336" target="_blank" rel="noopener noreferrer">request()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法，你会觉得奇怪，没有找到任何与 <code>jsonp</code> 相关的处理逻辑，这是为什么呢？我们马上来分析一下问题，大家应该还记得在 <strong>“JSONP 示例”</strong> 章节我们除了导入 <code>HttpClientModule</code> 模块之外，我们还导入了 <code>HttpClientJsonpModule</code> 模块，该模块的定义如下：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    JsonpClientBackend<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>provide<span class="token punctuation">:</span> JsonpCallbackContext<span class="token punctuation">,</span> useFactory<span class="token punctuation">:</span> jsonpCallbackContext<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>provide<span class="token punctuation">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token punctuation">:</span> JsonpInterceptor<span class="token punctuation">,</span> multi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HttpClientJsonpModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>HttpClientJsonpModule 模块很简单，模块只声明了 3 个 provider：</p> <ul><li>JsonpClientBackend：JSONP 服务内部实现；</li> <li>JsonpCallbackContext：回调上下文对象；</li> <li>JsonpInterceptor：JSONP 拦截器。</li></ul> <p>在 <a href="https://semlinker.com/ng-http-interceptor/" target="_blank" rel="noopener noreferrer">Angular HttpClient 拦截器<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这篇文章中，我们已经介绍了拦截器的作用与使用。那是不是我们通过 HttpClient 服务发送的 JSONP 请求被 JsonpInterceptor 拦截器处理了。眼见为实，我们来看一下 JsonpInterceptor 拦截器的定义：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JsonpInterceptor</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> jsonp<span class="token punctuation">:</span> JsonpClientBackend<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">intercept</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> HttpRequest<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> next<span class="token punctuation">:</span> HttpHandler<span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'JSONP'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jsonp<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req <span class="token keyword">as</span> HttpRequest<span class="token operator">&lt;</span>never<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Fall through for normal HTTP requests.</span>
    <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码中，关键的部分就是 <code>req.method === 'JSONP'</code>  这个条件语句中的处理逻辑。当发现当前请求的请求方法为 <code>'JSONP'</code> 时，则会把请求代理给 JsonpClientBackend 服务进行处理。</p> <h4 id="jsonpclientbackend-类及构造函数"><a href="#jsonpclientbackend-类及构造函数" aria-hidden="true" class="header-anchor">#</a> JsonpClientBackend 类及构造函数</h4> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JsonpClientBackend</span> <span class="token keyword">implements</span> <span class="token class-name">HttpBackend</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> callbackMap<span class="token punctuation">:</span> JsonpCallbackContext<span class="token punctuation">,</span> 
    @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">DOCUMENT</span><span class="token punctuation">)</span> <span class="token keyword">private</span> document<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中 HttpBackend 接口的定义如下：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">HttpBackend</span> <span class="token keyword">implements</span> <span class="token class-name">HttpHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">abstract</span> <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> HttpRequest<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">HttpHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">abstract</span> <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> HttpRequest<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 JsonpClientBackend 类的构造函数中，我们注入了 JsonpCallbackContext 和 document 对象，其中 JsonpCallbackContext Provider 的配置如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span> provide<span class="token punctuation">:</span> JsonpCallbackContext<span class="token punctuation">,</span> useFactory<span class="token punctuation">:</span> jsonpCallbackContext <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>即使用工厂函数来构造 JsonpCallbackContext 对象：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">jsonpCallbackContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Object <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> window<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>前面我们已经简单介绍了 JSONP 的实现原理，这里我们再回顾一下相关处理流程：</p> <ol><li>生成唯一的 callback 名称，构造请求的 URL 地址，比如 <code>https://itunes.apple.com/search?term=Photo&amp;media=music&amp;limit=20&amp;callback=ng_jsonp_callback_0</code>；</li> <li>动态创建 <code>script</code> 标签并为该元素绑定 load 和 error 事件；</li> <li>把新建的 <code>script</code> 标签添加到页面上。</li></ol> <p>好的基本的流程已经梳理清楚，我们再来看一下具体实现：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> HttpRequest<span class="token operator">&lt;</span>never<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 确保请求方法是'JSONP'和期望的响应类型是JSON</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'JSONP'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">JSONP_ERR_WRONG_METHOD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>responseType <span class="token operator">!==</span> <span class="token string">'json'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">JSONP_ERR_WRONG_RESPONSE_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>observer<span class="token punctuation">:</span> Observer<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="创建script并设置回调函数"><a href="#创建script并设置回调函数" aria-hidden="true" class="header-anchor">#</a> 创建script并设置回调函数</h4> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>observer<span class="token punctuation">:</span> Observer<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token comment">// let nextRequestId: number = 0;</span>
     <span class="token comment">// private nextCallback(): string { return `ng_jsonp_callback_${nextRequestId++}`; }</span>
      <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">nextCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 生成唯一的callback名称</span>
     <span class="token comment">// callback=JSONP_CALLBACK 转换为 callback=ng_jsonp_callback_0</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>urlWithParams<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/=JSONP_CALLBACK(&amp;|$)/</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>callback<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">$1`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建script元素并设定请求的URL地址</span>
      <span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      node<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>

      <span class="token comment">// The response object, if one has been received, or null otherwise.</span>
      <span class="token keyword">let</span> body<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token operator">|</span><span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token comment">// Whether the response callback has been called.</span>
      <span class="token keyword">let</span> finished<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

      <span class="token comment">// Whether the request has been cancelled (and thus any other callbacks)</span>
      <span class="token comment">// should be ignored.</span>
      <span class="token keyword">let</span> cancelled<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

      <span class="token comment">// 设置响应的回调函数，浏览器环境则是window对象</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callbackMap<span class="token punctuation">[</span>callback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Data has been received from the JSONP script. Firstly, delete this callback.</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callbackMap<span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Next, make sure the request wasn't cancelled in the meantime.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Set state to indicate data was received.</span>
        body <span class="token operator">=</span> data<span class="token punctuation">;</span>
        finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="load-和-error-回调函数"><a href="#load-和-error-回调函数" aria-hidden="true" class="header-anchor">#</a> load 和 error 回调函数</h4> <p>onLoad 回调函数</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">onLoad</span> <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">:</span> Event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Do nothing if the request has been cancelled.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Cleanup the page.</span>
        <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 请求失败构造响应对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>finished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// It hasn't, something went wrong with the request. Return an error via</span>
          <span class="token comment">// the Observable error path. All JSONP errors have status 0.</span>
          observer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpErrorResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token punctuation">,</span>
            status<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            statusText<span class="token punctuation">:</span> <span class="token string">'JSONP Error'</span><span class="token punctuation">,</span>
            error<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">JSONP_ERR_NO_CALLBACK</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 请求成功构造响应对象</span>
        observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          body<span class="token punctuation">,</span>
          status<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
          statusText<span class="token punctuation">:</span> <span class="token string">'OK'</span><span class="token punctuation">,</span> 
          url<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Complete the stream, the response is over.</span>
        observer<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>onError 回调函数</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> onError<span class="token punctuation">:</span> <span class="token function-variable function">any</span> <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">:</span> Error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the request was already cancelled, no need to emit anything.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Wrap the error in a HttpErrorResponse.</span>
        observer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpErrorResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          error<span class="token punctuation">,</span>
          status<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          statusText<span class="token punctuation">:</span> <span class="token string">'JSONP Error'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在 onLoad 和 onError 回调函数中，都调用 cleanup() 函数执行清理操作，该函数的实现如下：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">cleanup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// Remove the &lt;script&gt; tag if it's still on the page.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callbackMap<span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>定义完成功与异常处理函数，接下来就是为新建的 script 元素绑定对应事件，然后动态地添加该 script 元素：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> onLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>
node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The request has now been successfully sent.</span>
observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">type</span><span class="token punctuation">:</span> HttpEventType<span class="token punctuation">.</span>Sent<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此时到这里主要的流程都分析完了，其实还差一步，了解 Observable 对象的同学，估计已经猜到了。是的，没错我们还差可以执行取消订阅的逻辑：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  cancelled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// Remove the event listeners so they won't run if the events later fire.</span>
  node<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> onLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>
  node<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// And finally, clean up the page.</span>
  <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/angular-god-road/assets/js/34.c0d5a741.js" defer></script><script src="/angular-god-road/assets/js/app.4eaf616f.js" defer></script>
  </body>
</html>
